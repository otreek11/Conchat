# EMQX Configuration for Conchat

## Node name
node.name = emqx@127.0.0.1

## Node cookie for distributed erlang
node.cookie = "emqxsecretcookie"

## Node data directory
node.data_dir = "/opt/emqx/data"

## Cluster discovery strategy
cluster.discovery_strategy = manual

## Listeners
listeners.wss.default {
  bind = "0.0.0.0:8084"
  max_connections = 1024000

  ssl_options {
    cacertfile = "/opt/emqx/etc/certs/cert.pem"
    certfile = "/opt/emqx/etc/certs/cert.pem"
    keyfile = "/opt/emqx/etc/certs/key.pem"
    verify = verify_none
  }
}

listeners.ws.default {
  bind = "0.0.0.0:8083"
  max_connections = 1024000
}

## Dashboard
dashboard {
  listeners.http {
    bind = "0.0.0.0:18083"
  }
  default_username = "admin"
  default_password = "public"
}

## HTTP Authentication
authentication = [
  {
    mechanism = password_based
    backend = http

    method = post
    url = "http://webhooks:5001/webhooks/v1/connect"
    headers {
      "Content-Type" = "application/json"
    }

    body {
      clientid = "${clientid}"
      username = "${username}"
      password = "${password}"
    }

    enable = true
  }
]

## HTTP Authorization (ACL)
authorization {
  sources = [
    {
      type = http

      method = post
      url = "http://webhooks:5001/webhooks/v1/acl_auth"
      headers {
        "Content-Type" = "application/json"
      }

      body {
        clientid = "${clientid}"
        username = "${username}"
        password = "${password}"
        topic = "${topic}"
        action = "${action}"
      }

      enable = true
    }
  ]

  no_match = deny
  deny_action = disconnect
}

## Log
log {
  console {
    level = info
    enable = true
  }

  file {
    level = info
    enable = true
    path = "/opt/emqx/log"
    rotation_count = 10
    rotation_size = 50MB
  }
}

## MQTT Protocol Settings
mqtt {
  max_packet_size = 1MB
  max_clientid_len = 65535
  max_topic_levels = 128
  max_qos_allowed = 2
  retain_available = true
  wildcard_subscription = true
  shared_subscription = true
  ignore_loop_deliver = false
}

## Session Settings
session {
  max_subscriptions = 1024
  upgrade_qos = false
  max_inflight = 32
  retry_interval = 30s
  max_awaiting_rel = 100
  await_rel_timeout = 300s
  session_expiry_interval = 2h
  max_mqueue_len = 1000
  mqueue_priorities = disabled
  mqueue_default_priority = lowest
  mqueue_store_qos0 = true
}
